<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Cash Reconciliation & Sales System - Enhanced</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    
    :root {
      --primary:#10b981; 
      --primary-dark:#059669; 
      --secondary:#3b82f6;
      --danger:#ef4444; 
      --warning:#f59e0b; 
      --success:#22c55e;
      --dark:#111827; 
      --light:#f9fafb; 
      --border:#e5e7eb;
    }
    
    body { 
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto',sans-serif;
      background:linear-gradient(135deg,#059669 0%,#0891b2 100%);
      min-height:100vh; 
      padding:10px; 
    }
    
    .container { 
      max-width:1400px; 
      margin:0 auto; 
      background:#fff; 
      border-radius:20px;
      box-shadow:0 25px 50px -12px rgba(0,0,0,.25); 
      overflow:hidden; 
    }
    
    .header { 
      background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);
      color:#fff; 
      padding:20px; 
      position:relative; 
    }
    
    .header h1 { 
      font-size:24px; 
      font-weight:700; 
      margin-bottom:5px; 
    }
    
    .app-badge { 
      position:absolute; 
      top:20px; 
      right:20px; 
      background:rgba(255,255,255,.2);
      padding:8px 16px; 
      border-radius:20px; 
      font-size:12px; 
      font-weight:600;
      backdrop-filter:blur(10px); 
    }
    
    .route-section { 
      background:#f8f9fa; 
      padding:15px; 
      border-bottom:2px solid var(--border); 
    }
    
    .route-grid { 
      display:grid; 
      grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      gap:10px; 
      margin-bottom:15px; 
    }
    
    .route-btn { 
      padding:12px; 
      border:2px solid var(--border); 
      background:#fff; 
      border-radius:10px;
      cursor:pointer; 
      transition:.3s; 
      font-weight:600; 
      font-size:13px; 
      color:var(--dark); 
      text-align:center; 
    }
    
    .route-btn:hover { 
      border-color:var(--primary); 
      transform:translateY(-2px);
      box-shadow:0 5px 15px rgba(16,185,129,.2); 
    }
    
    .route-btn.active { 
      background:var(--primary); 
      color:#fff; 
      border-color:var(--primary); 
    }
    
    .date-info { 
      display:grid; 
      grid-template-columns:1fr 1fr; 
      gap:10px; 
    }
    
    .date-input { 
      padding:10px; 
      border:2px solid var(--border); 
      border-radius:8px; 
      font-size:14px; 
      font-weight:500; 
    }
    
    .info-display { 
      padding:10px; 
      background:#eff6ff; 
      border:2px solid #93c5fd; 
      border-radius:8px;
      text-align:center; 
      font-weight:600; 
      color:var(--secondary); 
    }
    
    /* Sync Status */
    .sync-status {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 10px 15px;
      border-radius: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 200;
    }
    
    .sync-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .sync-indicator.connected { background: var(--success); }
    .sync-indicator.disconnected { background: var(--danger); }
    .sync-indicator.syncing { 
      background: var(--warning); 
      animation: spin 1s linear infinite; 
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
    
    .sync-text {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
    }
    
    .content { padding:20px; }
    
    .grid-2 { 
      display:grid; 
      grid-template-columns:1fr 1fr; 
      gap:20px; 
      margin-bottom:20px; 
    }
    
    .section-card { 
      background:#fff; 
      border:1px solid var(--border); 
      border-radius:12px; 
      padding:20px;
      box-shadow:0 2px 4px rgba(0,0,0,.05); 
    }
    
    .section-title { 
      font-size:16px; 
      font-weight:700; 
      color:var(--dark); 
      margin-bottom:15px;
      padding-bottom:10px; 
      border-bottom:2px solid var(--border); 
    }
    
    .input-group { 
      display:flex; 
      justify-content:space-between; 
      align-items:center;
      margin-bottom:12px; 
      padding:8px 0; 
      border-bottom:1px solid #f3f4f6; 
    }
    
    .input-label { 
      font-size:14px; 
      font-weight:600; 
      color:#4b5563; 
      flex:1; 
    }
    
    .input-wrapper { 
      display:flex; 
      align-items:center; 
      gap:5px; 
    }
    
    .currency-prefix { 
      font-size:14px; 
      font-weight:600; 
      color:#6b7280; 
    }
    
    .input-field { 
      width:120px; 
      padding:8px 12px; 
      border:2px solid var(--border); 
      border-radius:6px;
      font-size:14px; 
      text-align:right; 
      font-weight:600; 
    }
    
    .input-field:focus { 
      outline:none; 
      border-color:var(--primary); 
      background:#f0fdf4; 
    }
    
    .input-field.positive { 
      border-color:var(--success); 
      background:#f0fdf4; 
    }
    
    .input-field.negative { 
      border-color:var(--danger); 
      background:#fef2f2; 
    }
    
    .result-field { 
      background:#f3f4f6; 
      font-weight:700; 
      cursor:not-allowed; 
    }
    
    .cash-breakdown { 
      display:grid; 
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); 
      gap:10px; 
      margin-top:15px; 
    }
    
    .denomination { 
      display:flex; 
      align-items:center; 
      gap:8px; 
      padding:8px; 
      background:#f9fafb; 
      border-radius:8px; 
    }
    
    .denom-label { 
      font-size:12px; 
      font-weight:600; 
      color:#6b7280; 
      min-width:40px; 
    }
    
    .denom-input { 
      width:60px; 
      padding:4px; 
      border:1px solid var(--border); 
      border-radius:4px; 
      text-align:center; 
      font-size:12px; 
    }
    
    .denom-value { 
      font-size:11px; 
      color:#9ca3af; 
      margin-left:auto; 
    }
    
    .sales-section { margin-top:30px; }
    
    .sales-table { 
      width:100%; 
      border-collapse:separate; 
      border-spacing:0; 
      background:#fff; 
      border-radius:8px; 
      overflow:hidden; 
    }
    
    .sales-table th { 
      background:var(--primary); 
      color:#fff; 
      padding:10px; 
      text-align:left; 
      font-size:12px;
      font-weight:600; 
      text-transform:uppercase; 
    }
    
    .sales-table td { 
      padding:10px; 
      border-bottom:1px solid var(--border); 
      font-size:13px; 
    }
    
    .sales-table tr:hover { background:#f9fafb; }
    
    .qty-input { 
      width:60px; 
      padding:4px; 
      border:1px solid var(--border); 
      border-radius:4px; 
      text-align:center; 
    }
    
    .summary-section { 
      margin-top:30px; 
      padding:20px; 
      background:linear-gradient(135deg,#059669,#0891b2);
      border-radius:12px; 
      color:#fff; 
    }
    
    .summary-grid { 
      display:grid; 
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); 
      gap:15px; 
      margin-top:15px; 
    }
    
    .summary-card { 
      background:rgba(255,255,255,.15); 
      padding:15px; 
      border-radius:8px; 
      backdrop-filter:blur(10px); 
    }
    
    .summary-label { 
      font-size:11px; 
      opacity:.9; 
      text-transform:uppercase; 
      margin-bottom:5px; 
    }
    
    .summary-value { 
      font-size:24px; 
      font-weight:700; 
    }
    
    .difference-indicator { 
      padding:12px; 
      border-radius:8px; 
      font-weight:700; 
      font-size:16px; 
      text-align:center; 
      margin:20px 0; 
    }
    
    .difference-indicator.balanced { 
      background:#d1fae5; 
      color:#065f46; 
      border:2px solid #10b981; 
    }
    
    .difference-indicator.shortage { 
      background:#fee2e2; 
      color:#991b1b; 
      border:2px solid #ef4444; 
    }
    
    .difference-indicator.excess { 
      background:#fef3c7; 
      color:#92400e; 
      border:2px solid #f59e0b; 
    }
    
    .btn-group { 
      display:flex; 
      gap:10px; 
      flex-wrap:wrap; 
      margin-top:20px; 
    }
    
    .btn { 
      padding:12px 20px; 
      border:none; 
      border-radius:8px; 
      cursor:pointer; 
      font-weight:600; 
      font-size:14px;
      transition:.3s; 
      display:inline-flex; 
      align-items:center; 
      gap:8px; 
    }
    
    .btn-primary{ background:var(--primary); color:#fff; }
    .btn-secondary{ background:var(--secondary); color:#fff; }
    .btn-danger{ background:var(--danger); color:#fff; }
    .btn-warning{ background:var(--warning); color:#fff; }
    
    .btn:hover{ 
      transform:translateY(-2px); 
      box-shadow:0 10px 20px rgba(0,0,0,.2); 
    }
    
    .btn:disabled{ 
      opacity:.5; 
      cursor:not-allowed; 
      transform:none; 
    }
    
    .status-message { 
      padding:12px 16px; 
      border-radius:8px; 
      margin-bottom:20px; 
      animation:slideIn .3s; 
      display: none;
    }
    
    .status-message.show {
      display: block;
    }
    
    @keyframes slideIn { 
      from{opacity:0; transform:translateX(-20px)} 
      to{opacity:1; transform:translateX(0)} 
    }
    
    .status-success{ 
      background:#d1fae5; 
      color:#065f46; 
      border:1px solid #10b981; 
    }
    
    .status-error{ 
      background:#fee2e2; 
      color:#991b1b; 
      border:1px solid #ef4444; 
    }
    
    .status-info{ 
      background:#e0f2fe; 
      color:#075985; 
      border:1px solid #06b6d4; 
    }
    
    .status-warning {
      background:#fef3c7;
      color:#92400e;
      border:1px solid #f59e0b;
    }
    
    .hidden{ display:none !important; }
    
    .loading-overlay { 
      position:fixed; 
      inset:0; 
      background:rgba(0,0,0,.7); 
      display:flex; 
      justify-content:center;
      align-items:center; 
      z-index:1000; 
    }
    
    .loading-spinner { 
      width:50px; 
      height:50px; 
      border:5px solid #f3f3f3; 
      border-top:5px solid var(--primary);
      border-radius:50%; 
      animation:spin 1s linear infinite; 
    }
    
    /* Sold/No-sale status */
    .status-badge{ 
      display:inline-block; 
      padding:4px 8px; 
      border-radius:999px; 
      font-size:11px; 
      font-weight:700 
    }
    
    .status-sold{ 
      background:#d1fae5; 
      color:#065f46; 
      border:1px solid #10b981 
    }
    
    .status-nosale{ 
      background:#f3f4f6; 
      color:#6b7280; 
      border:1px solid #e5e7eb 
    }
    
    tr.nosale{ opacity:.7 } 
    tr.sold{ background:#f0fdf4 }
    
  @media (max-width:768px){ 
    .grid-2{ grid-template-columns:1fr } 
    .input-field{ width:100px } 
  }
</style>
<!-- PWA Meta Tags -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#10b981">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" type="image/x-icon" href="favicon.ico">

<!-- PWA Service Worker Registration -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => console.log('Service Worker registered'))
      .catch(err => console.log('Service Worker registration failed'));
  });
}
</script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>💰 Daily Cash Reconciliation & Sales</h1>
      <p>Sales tracking and cash balance verification system</p>
      <div class="app-badge">ACCOUNTS</div>
    </div>

    <div class="route-section">
      <div class="route-grid">
        <button class="route-btn" onclick="app.selectRoute('Al-Hasa One')">Al-Hasa 1</button>
        <button class="route-btn" onclick="app.selectRoute('Al-Hasa Two')">Al-Hasa 2</button>
        <button class="route-btn" onclick="app.selectRoute('Al-Hasa Three')">Al-Hasa 3</button>
        <button class="route-btn" onclick="app.selectRoute('Al-Hasa Four')">Al-Hasa 4</button>
        <button class="route-btn" onclick="app.selectRoute('Al-Hasa Wholesale')">Wholesale</button>
      </div>
      <div class="date-info">
        <input type="date" class="date-input" id="salesDate">
        <div class="info-display">
          Route: <strong id="selectedRoute">Not Selected</strong>
        </div>
      </div>

      <button class="btn btn-warning" onclick="app.fetchInventoryData()" id="fetchBtn" style="margin-top:15px;width:100%;">
        🔄 Auto-Calculate Sales from Inventory
      </button>
    </div>

    <div class="content">
      <div id="statusMessage" class="status-message"></div>

      <!-- Sales Items -->
      <div class="sales-section">
        <h3 class="section-title">📦 Sales Items</h3>

        <div style="display:flex;gap:12px;align-items:center;margin:8px 0 12px">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
            <input type="checkbox" id="toggleSoldOnly" />
            <span>Show only sold items</span>
          </label>
          <span style="font-size:12px;color:#6b7280">Sold SKUs: <b id="soldCount">0</b></span>
          <span id="catalogStatus" style="margin-left:auto;font-size:12px;color:#6b7280">Catalog: loading…</span>
        </div>

        <table class="sales-table">
          <thead>
            <tr>
              <th>Category</th>
              <th>Code</th>
              <th>Item</th>
              <th>Unit</th>
              <th>Price (SAR)</th>
              <th>Qty Sold</th>
              <th>Total (SAR)</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="salesTableBody"></tbody>
          <tfoot>
            <tr style="background:#f3f4f6;font-weight:bold;">
              <td colspan="6" style="text-align:right;">Total Sales Value:</td>
              <td id="totalSalesDisplay">SAR 0.00</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Cash Reconciliation -->
      <div class="grid-2" style="margin-top:30px;">
        <div class="section-card">
          <h3 class="section-title">💳 Payment Methods</h3>

          <div class="input-group">
            <label class="input-label">Total Sales Value</label>
            <div class="input-wrapper">
              <span class="currency-prefix">SAR</span>
              <input type="number" class="input-field result-field" id="totalSalesValue" readonly>
            </div>
          </div>

          <div class="input-group">
            <label class="input-label">(-) Credit Sales</label>
            <div class="input-wrapper">
              <span class="currency-prefix">SAR</span>
              <input type="number" class="input-field negative" id="creditSales" step="0.01"
                     placeholder="0.00" onchange="app.calculateCashBalance()">
            </div>
          </div>

          <div class="input-group">
            <label class="input-label">(+) Credit Repayment</label>
            <div class="input-wrapper">
              <span class="currency-prefix">SAR</span>
              <input type="number" class="input-field positive" id="creditRepayment" step="0.01"
                     placeholder="0.00" onchange="app.calculateCashBalance()">
            </div>
          </div>

          <div class="input-group">
            <label class="input-label">(-) Bank POS</label>
            <div class="input-wrapper">
              <span class="currency-prefix">SAR</span>
              <input type="number" class="input-field negative" id="bankPOS" step="0.01"
                     placeholder="0.00" onchange="app.calculateCashBalance()">
            </div>
          </div>

          <div class="input-group">
            <label class="input-label">(-) Bank Transfer</label>
            <div class="input-wrapper">
              <span class="currency-prefix">SAR</span>
              <input type="number" class="input-field negative" id="bankTransfer" step="0.01"
                     placeholder="0.00" onchange="app.calculateCashBalance()">
            </div>
          </div>

          <div class="input-group">
            <label class="input-label">(-) Cheque</label>
            <div class="input-wrapper">
              <span class="currency-prefix">SAR</span>
              <input type="number" class="input-field negative" id="cheque" step="0.01"
                     placeholder="0.00" onchange="app.calculateCashBalance()">
            </div>
          </div>

          <div class="input-group" style="background:#f0fdf4;padding:12px;border-radius:8px;margin-top:10px;">
            <label class="input-label" style="font-size:16px;">Expected Cash Balance</label>
            <div class="input-wrapper">
              <span class="currency-prefix" style="font-size:16px;">SAR</span>
              <input type="number" class="input-field result-field" id="expectedCashBalance"
                     readonly style="font-size:16px;color:#059669;">
            </div>
          </div>
        </div>

        <div class="section-card">
          <h3 class="section-title">💵 Cash Count</h3>

          <div class="input-group">
            <label class="input-label">Cash Notes Total</label>
            <div class="input-wrapper">
              <span class="currency-prefix">SAR</span>
              <input type="number" class="input-field" id="cashNotes" step="0.01" placeholder="0.00" readonly>
            </div>
          </div>

          <div class="cash-breakdown">
            <div class="denomination">
              <span class="denom-label">500</span>
              <input type="number" class="denom-input" id="note500" placeholder="0" onchange="app.calculateCashNotes()">
              <span class="denom-value" id="val500">0</span>
            </div>
            <div class="denomination">
              <span class="denom-label">100</span>
              <input type="number" class="denom-input" id="note100" placeholder="0" onchange="app.calculateCashNotes()">
              <span class="denom-value" id="val100">0</span>
            </div>
            <div class="denomination">
              <span class="denom-label">50</span>
              <input type="number" class="denom-input" id="note50" placeholder="0" onchange="app.calculateCashNotes()">
              <span class="denom-value" id="val50">0</span>
            </div>
            <div class="denomination">
              <span class="denom-label">20</span>
              <input type="number" class="denom-input" id="note20" placeholder="0" onchange="app.calculateCashNotes()">
              <span class="denom-value" id="val20">0</span>
            </div>
            <div class="denomination">
              <span class="denom-label">10</span>
              <input type="number" class="denom-input" id="note10" placeholder="0" onchange="app.calculateCashNotes()">
              <span class="denom-value" id="val10">0</span>
            </div>
            <div class="denomination">
              <span class="denom-label">5</span>
              <input type="number" class="denom-input" id="note5" placeholder="0" onchange="app.calculateCashNotes()">
              <span class="denom-value" id="val5">0</span>
            </div>
          </div>

          <div class="input-group" style="margin-top:15px;">
            <label class="input-label">Coins Total</label>
            <div class="input-wrapper">
              <span class="currency-prefix">SAR</span>
              <input type="number" class="input-field" id="coinsTotal" step="0.01" placeholder="0.00"
                     onchange="app.calculateActualCash()">
            </div>
          </div>

          <div class="input-group" style="background:#eff6ff;padding:12px;border-radius:8px;margin-top:10px;">
            <label class="input-label" style="font-size:16px;">Actual Cash Total</label>
            <div class="input-wrapper">
              <span class="currency-prefix" style="font-size:16px;">SAR</span>
              <input type="number" class="input-field result-field" id="actualCashTotal"
                     readonly style="font-size:16px;color:#2563eb;">
            </div>
          </div>
        </div>
      </div>

      <!-- Difference -->
      <div id="differenceIndicator" class="difference-indicator balanced">
        <div style="font-size:14px;opacity:.8;margin-bottom:5px;">Cash Difference</div>
        <div id="cashDifference" style="font-size:28px;">SAR 0.00</div>
        <div id="differenceStatus" style="font-size:12px;margin-top:5px;">Balanced</div>
      </div>

      <!-- Summary -->
      <div class="summary-section">
        <h3>📊 Daily Summary</h3>
        <div class="summary-grid">
          <div class="summary-card">
            <div class="summary-label">Total Sales</div>
            <div class="summary-value" id="summaryTotalSales">SAR 0</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Cash Collected</div>
            <div class="summary-value" id="summaryCashCollected">SAR 0</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Credit Sales</div>
            <div class="summary-value" id="summaryCreditSales">SAR 0</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Bank Deposits</div>
            <div class="summary-value" id="summaryBankDeposits">SAR 0</div>
          </div>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn btn-primary" onclick="app.saveData()" id="saveBtn">💾 Save to Google Sheets</button>
        <button class="btn btn-secondary" onclick="app.exportReport()">📄 Export Report</button>
        <button class="btn btn-danger" onclick="app.clearData()">🗑️ Clear All</button>
      </div>
    </div>
  </div>

  <!-- Sync Status -->
  <div class="sync-status">
    <div class="sync-indicator disconnected" id="syncIndicator"></div>
    <span class="sync-text" id="syncText">Connecting...</span>
  </div>

  <!-- Loading -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-spinner"></div>
  </div>

  <script>
    // Enhanced Cash Reconciliation App with robust error handling
    class CashReconciliationApp {
    constructor() {
        // Configuration from external config.js
        this.WEBHOOK_URL = CONFIG.GOOGLE_SCRIPT_URL;
        this.RETRY_ATTEMPTS = CONFIG.RETRY_ATTEMPTS || 3;
        this.RETRY_DELAY = CONFIG.RETRY_DELAY || 2000;
        
        // State
        this.currentRoute = '';
        this.CATALOG = {};
        this.SKU_INDEX = {};
        this.isOnline = navigator.onLine;
        this.pendingChanges = [];
        
        // Bind event handlers
        this.bindEventHandlers();
      }
      
      bindEventHandlers() {
        // Online/offline handlers
        window.addEventListener('online', () => this.handleOnlineStatus(true));
        window.addEventListener('offline', () => this.handleOnlineStatus(false));
      }
      
      handleOnlineStatus(isOnline) {
        this.isOnline = isOnline;
        this.updateSyncStatus(isOnline ? 'connected' : 'disconnected');
        
        if (isOnline) {
          this.showStatus('Back online - syncing data', 'info');
          this.syncPendingChanges();
        } else {
          this.showStatus('Working offline - data will sync when connection restored', 'warning');
        }
      }
      
      async init() {
        try {
          // Set today's date
          const today = new Date();
          document.getElementById('salesDate').value = today.toISOString().split('T')[0];
          
          // Bind filter
          document.getElementById('toggleSoldOnly').addEventListener('change', () => this.applySoldOnlyFilter());
          
          // Load catalog then render table
          await this.loadCatalog();
          this.renderSalesTableFromCatalog();
          this.loadFromStorage();
          this.recomputeSalesGrandTotal();
          
          // Check connection
          await this.checkConnection();
        } catch (error) {
          console.error('Init error:', error);
          this.showStatus('Starting in offline mode', 'warning');
        }
      }
      
      async checkConnection() {
        try {
          const response = await this.fetchWithRetry(`${this.WEBHOOK_URL}?action=ping`);
          const data = await response.json();
          if (data.success) {
            this.updateSyncStatus('connected');
          } else {
            throw new Error('Connection failed');
          }
        } catch (error) {
          this.updateSyncStatus('disconnected');
        }
      }
      
      async fetchWithRetry(url, options = {}, attempt = 1) {
        try {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 10000);
          
          const response = await fetch(url, {
            ...options,
            signal: controller.signal
          });
          
          clearTimeout(timeout);
          
          if (!response.ok && attempt < this.RETRY_ATTEMPTS) {
            await this.delay(this.RETRY_DELAY * attempt);
            return this.fetchWithRetry(url, options, attempt + 1);
          }
          
          return response;
        } catch (error) {
          if (attempt < this.RETRY_ATTEMPTS) {
            await this.delay(this.RETRY_DELAY * attempt);
            return this.fetchWithRetry(url, options, attempt + 1);
          }
          throw error;
        }
      }
      
      delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }
      
      selectRoute(route) {
        this.currentRoute = route;
        document.getElementById('selectedRoute').textContent = route;
        
        document.querySelectorAll('.route-btn').forEach(btn => {
          btn.classList.remove('active');
          const btnText = btn.textContent;
          if (btnText.includes(route.replace('Al-Hasa ', '')) || 
              (btnText === 'Wholesale' && route === 'Al-Hasa Wholesale')) {
            btn.classList.add('active');
          }
        });
        
        this.saveToStorage();
      }
      
      async loadCatalog() {
        this.setCatalogStatus('loading');
        
        try {
          const res = await this.fetchWithRetry(`${this.WEBHOOK_URL}?action=init`);
          const json = await res.json();
          
          if (!json || !json.success) {
            throw new Error('Failed to load catalog');
          }
          
          const cat = (json.data && json.data.catalog) ? json.data.catalog : null;
          if (!cat || typeof cat !== 'object') {
            throw new Error('Invalid catalog format');
          }
          
          // Transform catalog keys to proper format
          this.CATALOG = {};
          Object.entries(cat).forEach(([key, items]) => {
            // Convert snake_case to Title Case
            const categoryName = key.split('_')
              .map(word => word.charAt(0).toUpperCase() + word.slice(1))
              .join(' ');
            this.CATALOG[categoryName] = items;
          });
          
          this.buildSkuIndex(this.CATALOG);
          this.setCatalogStatus('ready');
        } catch (e) {
          console.error('Catalog load failed:', e);
          this.setCatalogStatus('error');
          
          // Use default catalog as fallback
          this.CATALOG = {
            'Sunflower Seeds': [
              {code: '4402', name: '200g', unit: 'bag', price: 58},
              {code: '4401', name: '100g', unit: 'bag', price: 34},
              {code: '1129', name: '25g', unit: 'bag', price: 16},
              {code: '1116', name: '800g', unit: 'bag', price: 17},
              {code: '1145', name: '130g', unit: 'box', price: 54},
              {code: '1126', name: '10KG', unit: 'sack', price: 160}
            ],
            'Pumpkin Seeds': [
              {code: '8001', name: '15g', unit: 'box', price: 16},
              {code: '8002', name: '110g', unit: 'box', price: 54},
              {code: '1142', name: '10KG', unit: 'sack', price: 230}
            ],
            'Melon Seeds': [
              {code: '9001', name: '15g', unit: 'box', price: 16},
              {code: '9002', name: '110g', unit: 'box', price: 54}
            ],
            'Popcorn': [
              {code: '1701', name: 'Cheese', unit: 'bag', price: 5},
              {code: '1702', name: 'Butter', unit: 'bag', price: 5},
              {code: '1703', name: 'Lightly Salted', unit: 'bag', price: 5}
            ]
          };
          this.buildSkuIndex(this.CATALOG);
        }
      }
      
      buildSkuIndex(cat) {
        this.SKU_INDEX = {};
        Object.entries(cat).forEach(([category, items]) => {
          (items || []).forEach(item => {
            this.SKU_INDEX[item.code] = {
              category,
              code: item.code,
              name: item.name || '',
              unit: item.unit || '',
              price: Number(item.price || 0)
            };
          });
        });
      }
      
      setCatalogStatus(state) {
        const el = document.getElementById('catalogStatus');
        if (!el) return;
        if (state === 'loading') el.textContent = 'Catalog: loading…';
        else if (state === 'ready') el.textContent = 'Catalog: ready';
        else el.textContent = 'Catalog: using default';
      }
      
      renderSalesTableFromCatalog() {
        const tbody = document.getElementById('salesTableBody');
        tbody.innerHTML = '';
        
        const categories = Object.keys(this.CATALOG);
        categories.forEach(category => {
          (this.CATALOG[category] || []).forEach(item => {
            const tr = document.createElement('tr');
            tr.setAttribute('data-code', item.code);
            tr.classList.add('nosale');
            
            tr.innerHTML = `
              <td>${category}</td>
              <td>${item.code}</td>
              <td>${item.name || ''}</td>
              <td>${item.unit || ''}</td>
              <td>${Number(item.price || 0)}</td>
              <td>
                <input type="number" class="qty-input" id="qty_${item.code}"
                       placeholder="0" min="0"
                       onchange="app.handleQtyChange('${item.code}', ${Number(item.price || 0)})">
              </td>
              <td id="total_${item.code}">0.00</td>
              <td id="status_${item.code}">
                <span class="status-badge status-nosale">No Sale</span>
              </td>
            `;
            tbody.appendChild(tr);
          });
        });
        
        // Initialize statuses
        Object.values(this.SKU_INDEX).forEach(meta => this.updateRowStatus(meta.code, 0));
      }
      
      handleQtyChange(code, price) {
        const qty = this.toNum(document.getElementById(`qty_${code}`).value);
        document.getElementById(`total_${code}`).textContent = (qty * price).toFixed(2);
        this.updateRowStatus(code, qty);
        this.recomputeSalesGrandTotal();
        this.applySoldOnlyFilter();
        this.saveToStorage();
      }
      
      updateRowStatus(code, qty) {
        const tr = document.querySelector(`tr[data-code="${code}"]`);
        const cell = document.getElementById(`status_${code}`);
        if (!tr || !cell) return;
        
        if (qty > 0) {
          tr.classList.add('sold');
          tr.classList.remove('nosale');
          cell.innerHTML = `<span class="status-badge status-sold">Sold</span>`;
        } else {
          tr.classList.add('nosale');
          tr.classList.remove('sold');
          cell.innerHTML = `<span class="status-badge status-nosale">No Sale</span>`;
        }
      }
      
      applySoldOnlyFilter() {
        const soldOnly = document.getElementById('toggleSoldOnly').checked;
        document.querySelectorAll('#salesTableBody tr').forEach(tr => {
          const code = tr.getAttribute('data-code');
          const qty = this.toNum(document.getElementById(`qty_${code}`).value);
          tr.style.display = (soldOnly && qty === 0) ? 'none' : '';
        });
      }
      
      recomputeSalesGrandTotal() {
        let grand = 0, sold = 0;
        
        Object.values(this.SKU_INDEX).forEach(meta => {
          const qtyEl = document.getElementById(`qty_${meta.code}`);
          if (!qtyEl) return;
          
          const qty = this.toNum(qtyEl.value);
          const total = qty * Number(meta.price || 0);
          if (qty > 0) sold++;
          grand += total;
        });
        
        this.setText('totalSalesDisplay', `SAR ${grand.toFixed(2)}`);
        this.setValue('totalSalesValue', grand.toFixed(2));
        this.setText('summaryTotalSales', `SAR ${grand.toFixed(2)}`);
        this.setText('soldCount', sold);
        this.calculateCashBalance();
      }
      
      async fetchInventoryData() {
        if (!this.currentRoute) {
          return this.showStatus('Please select a route first!', 'error');
        }
        
        const salesDate = this.getValue('salesDate');
        if (!salesDate) {
          return this.showStatus('Please select a date!', 'error');
        }
        
        // Calculate previous day
        const cur = new Date(salesDate);
        const prev = new Date(cur);
        prev.setDate(prev.getDate() - 1);
        const prevStr = prev.toISOString().split('T')[0];
        
        this.showStatus('Fetching inventory data…', 'info');
        this.showLoading(true);
        document.getElementById('fetchBtn').disabled = true;
        
        try {
          const res = await this.fetchWithRetry(this.WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'calculateSalesFromInventory',
              route: this.currentRoute,
              currentDate: salesDate,
              previousDate: prevStr
            })
          });
          
          const json = await res.json();
          
          if (json.status === 'success' && Array.isArray(json.data)) {
            this.populateSalesDataFromCalc(json.data);
            this.showStatus('Sales data calculated from inventory!', 'success');
          } else {
            this.showStatus('No inventory data found for calculation', 'error');
          }
        } catch (e) {
          console.error(e);
          this.showStatus('Unable to fetch inventory data. Please enter manually.', 'error');
        } finally {
          this.showLoading(false);
          document.getElementById('fetchBtn').disabled = false;
        }
      }
      
      populateSalesDataFromCalc(rows) {
        // Clear all quantities
        Object.values(this.SKU_INDEX).forEach(meta => {
          const input = document.getElementById(`qty_${meta.code}`);
          if (input) input.value = '';
          this.setText(`total_${meta.code}`, '0.00');
          this.updateRowStatus(meta.code, 0);
        });
        
        // Fill from backend
        rows.forEach(r => {
          const code = r.code;
          const qty = this.toNum(r.salesQty);
          const meta = this.SKU_INDEX[code];
          if (!meta) return;
          
          const input = document.getElementById(`qty_${code}`);
          if (input) {
            input.value = qty;
            this.setText(`total_${code}`, (qty * Number(meta.price || 0)).toFixed(2));
            this.updateRowStatus(code, qty);
          }
        });
        
        this.recomputeSalesGrandTotal();
        this.applySoldOnlyFilter();
      }
      
      calculateCashBalance() {
        const totalSales = this.toNum(this.getValue('totalSalesValue'));
        const creditSales = this.toNum(this.getValue('creditSales'));
        const creditRepayment = this.toNum(this.getValue('creditRepayment'));
        const bankPOS = this.toNum(this.getValue('bankPOS'));
        const bankTransfer = this.toNum(this.getValue('bankTransfer'));
        const cheque = this.toNum(this.getValue('cheque'));
        
        const expected = totalSales - creditSales + creditRepayment - bankPOS - bankTransfer - cheque;
        this.setValue('expectedCashBalance', expected.toFixed(2));
        
        this.setText('summaryCreditSales', `SAR ${creditSales.toFixed(2)}`);
        const bankDeposits = bankPOS + bankTransfer + cheque;
        this.setText('summaryBankDeposits', `SAR ${bankDeposits.toFixed(2)}`);
        
        this.calculateDifference();
        this.saveToStorage();
      }
      
      calculateCashNotes() {
        const denoms = [500, 100, 50, 20, 10, 5];
        let total = 0;
        
        denoms.forEach(d => {
          const count = this.toNum(this.getValue(`note${d}`));
          const val = count * d;
          this.setText(`val${d}`, val);
          total += val;
        });
        
        this.setValue('cashNotes', total.toFixed(2));
        this.calculateActualCash();
      }
      
      calculateActualCash() {
        const notes = this.toNum(this.getValue('cashNotes'));
        const coins = this.toNum(this.getValue('coinsTotal'));
        const actual = notes + coins;
        
        this.setValue('actualCashTotal', actual.toFixed(2));
        this.setText('summaryCashCollected', `SAR ${actual.toFixed(2)}`);
        this.calculateDifference();
        this.saveToStorage();
      }
      
      calculateDifference() {
        const expected = this.toNum(this.getValue('expectedCashBalance'));
        const actual = this.toNum(this.getValue('actualCashTotal'));
        const diff = actual - expected;
        
        this.setText('cashDifference', `SAR ${diff.toFixed(2)}`);
        
        const ind = document.getElementById('differenceIndicator');
        const status = document.getElementById('differenceStatus');
        
        if (Math.abs(diff) < 0.01) {
          ind.className = 'difference-indicator balanced';
          status.textContent = 'Balanced';
        } else if (diff < 0) {
          ind.className = 'difference-indicator shortage';
          status.textContent = `Cash Short by SAR ${Math.abs(diff).toFixed(2)}`;
        } else {
          ind.className = 'difference-indicator excess';
          status.textContent = `Cash Over by SAR ${diff.toFixed(2)}`;
        }
      }
      
      async saveData() {
        if (!this.currentRoute) {
          return this.showStatus('Please select a route!', 'error');
        }
        
        const date = this.getValue('salesDate');
        if (!date) {
          return this.showStatus('Please select a date!', 'error');
        }
        
        const btn = document.getElementById('saveBtn');
        btn.disabled = true;
        this.showLoading(true);
        
        const payload = this.collectData();
        
        try {
          const res = await this.fetchWithRetry(this.WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              action: 'saveCashReconciliation', 
              ...payload 
            })
          });
          
          const json = await res.json();
          
          if (json.status === 'success') {
            this.showStatus('Data saved successfully!', 'success');
            this.updateSyncStatus('connected');
          } else {
            throw new Error(json.error || 'Save failed');
          }
        } catch (e) {
          console.error('Save error:', e);
          this.pendingChanges.push(payload);
          this.showStatus('Saved locally. Will sync when connection restored.', 'warning');
          this.updateSyncStatus('disconnected');
        } finally {
          btn.disabled = false;
          this.showLoading(false);
        }
      }
      
      async syncPendingChanges() {
        if (!this.isOnline || this.pendingChanges.length === 0) return;
        
        const changes = [...this.pendingChanges];
        this.pendingChanges = [];
        
        for (const change of changes) {
          try {
            const response = await this.fetchWithRetry(this.WEBHOOK_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                action: 'saveCashReconciliation',
                ...change
              })
            });
            
            const result = await response.json();
            
            if (result.status !== 'success') {
              this.pendingChanges.push(change);
            }
          } catch (error) {
            this.pendingChanges.push(change);
          }
        }
        
        if (this.pendingChanges.length === 0) {
          this.showStatus('All pending changes synced', 'success');
        }
      }
      
      collectData() {
        const salesItems = [];
        
        Object.values(this.SKU_INDEX).forEach(meta => {
          const qtyEl = document.getElementById(`qty_${meta.code}`);
          if (!qtyEl) return;
          
          const qty = this.toNum(qtyEl.value);
          if (qty > 0) {
            salesItems.push({
              category: meta.category,
              code: meta.code,
              name: meta.name,
              unit: meta.unit,
              price: Number(meta.price || 0),
              quantity: qty,
              total: qty * Number(meta.price || 0)
            });
          }
        });
        
        return {
          route: this.currentRoute,
          date: this.getValue('salesDate'),
          salesItems,
          totalSales: this.toNum(this.getValue('totalSalesValue')),
          creditSales: this.toNum(this.getValue('creditSales')),
          creditRepayment: this.toNum(this.getValue('creditRepayment')),
          bankPOS: this.toNum(this.getValue('bankPOS')),
          bankTransfer: this.toNum(this.getValue('bankTransfer')),
          cheque: this.toNum(this.getValue('cheque')),
          expectedCash: this.toNum(this.getValue('expectedCashBalance')),
          cashNotes: {
            total: this.toNum(this.getValue('cashNotes')),
            denominations: {
              500: this.toNum(this.getValue('note500')),
              100: this.toNum(this.getValue('note100')),
              50: this.toNum(this.getValue('note50')),
              20: this.toNum(this.getValue('note20')),
              10: this.toNum(this.getValue('note10')),
              5: this.toNum(this.getValue('note5'))
            }
          },
          coins: this.toNum(this.getValue('coinsTotal')),
          actualCash: this.toNum(this.getValue('actualCashTotal')),
          difference: this.toNum(this.getValue('actualCashTotal')) - this.toNum(this.getValue('expectedCashBalance')),
          timestamp: new Date().toISOString()
        };
      }
      
      exportReport() {
        const data = this.collectData();
        const date = this.getValue('salesDate') || 'unknown';
        
        let csv = 'Daily Cash Reconciliation Report\n';
        csv += `Date,${date}\n`;
        csv += `Route,${this.currentRoute || 'Not Selected'}\n\n`;
        
        csv += 'SALES ITEMS\n';
        csv += 'Category,Code,Item,Unit,Price,Quantity,Total\n';
        data.salesItems.forEach(i => {
          csv += `${i.category},${i.code},${i.name},${i.unit},${i.price},${i.quantity},${i.total}\n`;
        });
        
        csv += '\nCASH RECONCILIATION\n';
        csv += `Total Sales,${data.totalSales}\n`;
        csv += `Credit Sales,${data.creditSales}\n`;
        csv += `Credit Repayment,${data.creditRepayment}\n`;
        csv += `Bank POS,${data.bankPOS}\n`;
        csv += `Bank Transfer,${data.bankTransfer}\n`;
        csv += `Cheque,${data.cheque}\n`;
        csv += `Expected Cash,${data.expectedCash}\n`;
        csv += `Actual Cash,${data.actualCash}\n`;
        csv += `Difference,${data.difference}\n`;
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cash_reconciliation_${this.currentRoute}_${date}.csv`;
        a.click();
        
        this.showStatus('Report exported!', 'success');
      }
      
      clearData() {
        if (!confirm('Clear all data?')) return;
        
        // Clear quantities
        Object.values(this.SKU_INDEX).forEach(meta => {
          this.setValue(`qty_${meta.code}`, '');
          this.setText(`total_${meta.code}`, '0.00');
          this.updateRowStatus(meta.code, 0);
        });
        
        // Clear payments
        ['creditSales', 'creditRepayment', 'bankPOS', 'bankTransfer', 'cheque', 'coinsTotal']
          .forEach(id => this.setValue(id, ''));
        
        // Clear notes
        [500, 100, 50, 20, 10, 5].forEach(d => this.setValue(`note${d}`, ''));
        
        // Recompute
        this.recomputeSalesGrandTotal();
        this.calculateCashNotes();
        this.showStatus('Data cleared!', 'success');
        
        localStorage.removeItem('cashReconciliationData');
      }
      
      saveToStorage() {
        const data = this.collectData();
        localStorage.setItem('cashReconciliationData', JSON.stringify(data));
      }
      
      loadFromStorage() {
        const saved = localStorage.getItem('cashReconciliationData');
        if (!saved) return;
        
        try {
          const data = JSON.parse(saved);
          
          if (data.route) this.selectRoute(data.route);
          if (data.date) this.setValue('salesDate', data.date);
          
          // Sales items
          (data.salesItems || []).forEach(i => {
            if (this.SKU_INDEX[i.code]) {
              this.setValue(`qty_${i.code}`, i.quantity);
              this.setText(`total_${i.code}`, (i.quantity * Number(this.SKU_INDEX[i.code].price || 0)).toFixed(2));
              this.updateRowStatus(i.code, i.quantity);
            }
          });
          
          // Payments
          this.setValue('creditSales', data.creditSales || '');
          this.setValue('creditRepayment', data.creditRepayment || '');
          this.setValue('bankPOS', data.bankPOS || '');
          this.setValue('bankTransfer', data.bankTransfer || '');
          this.setValue('cheque', data.cheque || '');
          this.setValue('coinsTotal', data.coins || '');
          
          // Notes
          if (data.cashNotes && data.cashNotes.denominations) {
            Object.entries(data.cashNotes.denominations).forEach(([denom, count]) => {
              this.setValue(`note${denom}`, count || '');
            });
          }
          
          // Recompute
          this.recomputeSalesGrandTotal();
          this.calculateCashNotes();
        } catch (e) {
          console.error('Load storage failed:', e);
        }
      }
      
      // Utility functions
      getValue(id) {
        const el = document.getElementById(id);
        return el ? el.value : '';
      }
      
      setValue(id, v) {
        const el = document.getElementById(id);
        if (el) el.value = v;
      }
      
      setText(id, t) {
        const el = document.getElementById(id);
        if (el) el.textContent = t;
      }
      
      toNum(v) {
        const n = Number(v);
        return isNaN(n) ? 0 : n;
      }
      
      showStatus(message, type) {
        const div = document.getElementById('statusMessage');
        div.className = `status-message status-${type} show`;
        div.textContent = message;
        
        setTimeout(() => {
          div.classList.remove('show');
        }, 4000);
      }
      
      showLoading(show = true) {
        const overlay = document.getElementById('loadingOverlay');
        if (!overlay) return;
        
        if (show) {
          overlay.classList.remove('hidden');
        } else {
          overlay.classList.add('hidden');
        }
      }
      
      updateSyncStatus(status) {
        const indicator = document.getElementById('syncIndicator');
        const text = document.getElementById('syncText');
        
        indicator.className = `sync-indicator ${status}`;
        
        if (status === 'connected') {
          text.textContent = 'Connected';
        } else if (status === 'disconnected') {
          text.textContent = 'Offline';
        } else if (status === 'syncing') {
          text.textContent = 'Syncing...';
        }
      }
    }
    
    // Initialize app
    const app = new CashReconciliationApp();
    document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
    src="config.js">
    </script>
    <script>
// Performance monitoring
window.addEventListener('load', () => {
    const perfData = window.performance.timing;
    const pageLoadTime = perfData.loadEventEnd - perfData.navigationStart;
    console.log('Page load time:', pageLoadTime + 'ms');
    
    // Send to analytics if needed
    if (pageLoadTime > 3000) {
        console.warn('Slow page load detected');
    }
});

// Monitor API calls
const originalFetch = window.fetch;
window.fetch = async function(...args) {
    const startTime = performance.now();
    try {
        const response = await originalFetch.apply(this, args);
        const endTime = performance.now();
        console.log(`API call took ${endTime - startTime}ms`);
        return response;
    } catch (error) {
        console.error('API call failed:', error);
        throw error;
    }
};
</script>
</body>
</html>